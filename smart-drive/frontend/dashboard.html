<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard - Cloud Smart Storage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">Cloud Smart Storage</a>
        <div class="d-flex">
          <button class="btn btn-outline-light" id="logoutBtn">Logout</button>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <div id="alert" class="alert d-none" role="alert"></div>

      <div class="card p-3 shadow-sm mb-4">
        <h5 class="mb-3">Upload a file</h5>
        <form id="uploadForm" class="d-flex gap-2 align-items-center">
          <input class="form-control" type="file" id="fileInput" required>
          <button type="submit" class="btn btn-primary">Upload</button>
        </form>
      </div>

      <div class="card p-3 shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Your Files</h5>
          <button class="btn btn-sm btn-outline-secondary" id="refreshBtn">Refresh</button>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>File Name</th>
                <th>Uploaded</th>
                <th>Open</th>
                <th>Share</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody id="filesTbody">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="script.js"></script>
    <script>
      guardAuthOrRedirect();

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('token');
        window.location.href = 'login.html';
      });

      document.getElementById('refreshBtn').addEventListener('click', loadFiles);

      document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('fileInput');
        if (!input.files.length) return;
        const file = input.files[0];
        const res = await apiUpload('/api/upload', file);
        if (res.ok) {
          showAlert('Uploaded successfully', 'success');
          input.value = '';
          await loadFiles();
        } else {
          showAlert(res.data.message || 'Upload failed', 'danger');
        }
      });

      async function loadFiles() {
        const res = await apiGet('/api/files');
        const tbody = document.getElementById('filesTbody');
        tbody.innerHTML = '';
        if (!res.ok) {
          showAlert(res.data.message || 'Failed to load files', 'danger');
          return;
        }
        const files = res.data.files || [];
        if (!files.length) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No files yet</td></tr>';
          return;
        }
        files.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.file_name}</td>
            <td>${item.upload_date || ''}</td>
            <td><a class="btn btn-sm btn-outline-primary" href="${item.file_url}" target="_blank">Open</a></td>
            <td><button class="btn btn-sm btn-outline-success" data-action="share" data-fn="${item.file_name}">Copy Link</button></td>
            <td><button class="btn btn-sm btn-outline-danger" data-action="delete" data-fn="${item.file_name}">Delete</button></td>
          `;
          tbody.appendChild(tr);
        });

        tbody.querySelectorAll('button[data-action="share"]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const fn = btn.getAttribute('data-fn');
            const resShare = await apiGet(`/api/share/${encodeURIComponent(fn)}`);
            if (resShare.ok) {
              await copyToClipboard(resShare.data.share_url);
              showAlert('Share link copied (valid 1 hour)', 'success');
            } else {
              showAlert(resShare.data.message || 'Could not get share link', 'danger');
            }
          });
        });

        tbody.querySelectorAll('button[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const fn = btn.getAttribute('data-fn');
            if (!confirm(`Delete ${fn}?`)) return;
            const resDel = await apiDelete(`/api/delete/${encodeURIComponent(fn)}`);
            if (resDel.ok) {
              showAlert('Deleted', 'success');
              await loadFiles();
            } else {
              showAlert(resDel.data.message || 'Delete failed', 'danger');
            }
          });
        });
      }

      loadFiles();
    </script>
  </body>
  </html>


